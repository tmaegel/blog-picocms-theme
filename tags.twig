<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

    <title>{% if meta.title %}{{ meta.title }} | {% endif %}{{ site_title }}</title>
    {% if meta.description %}
      <meta name="description" content="{{ meta.description|striptags }}" />
    {% endif %}
    {% if meta.robots %}
      <meta name="robots" content="{{ meta.robots }}" />
    {% endif %}

    {% if current_page %}
      <link rel="canonical" href="{{ current_page.url }}" />
    {% endif %}

    <link rel="stylesheet" href="{{ theme_url }}/css/style.css" type="text/css" />
  </head>
  <body{% if config.theme_config.widescreen %} class="widescreen"{% endif %}>

    <div id="main" role="main">

      {% set tag = url_param('tag', 'string') %}
      {% set tags = get_all_tags() %}

      {% block content %}

      {% if tag %}

        {# List of all pages with a specified tag #}
        <div id="header" role="banner">
          <h1 id="page-title">Tag: #{{ tag }}</h1>
        </div>
        <div id="content">
          {% set year = 0 %}
          {% for page in pages if page.title and tags and not (page.id ends with 'index') %}
            {% set act_year = page.date_formatted|date("Y") %}

            {% if page.meta.tags is iterable %}
              {% set pageTags = page.meta.tags %}
            {% else %}
              {% set pageTags = page.meta.tags|split(',') %}
            {% endif %}

            {% for pageTag in pageTags %}
              {% if pageTag|trim == tag %}

                  {% if year == 0 %}
                    <div class="post-group">
                      <div class="post-year">
                        {{ act_year }}
                      </div>
                    <ul>
                  {% else %}
                    {% if year != act_year %}
                    </ul></div> <!-- End ul / post-group -->
                    <div class="post-group">
                      <div class="post-year">
                        {{ act_year }}
                      </div>
                    <ul>
                    {% endif %}
                  {% endif %}

                  <li><h2 class="post-title"><a href="{{ page.url }}">{{ page.title }}</a></h2></li>
                  {% set year = act_year %}

              {% endif %}
            {% endfor %}

          {% endfor %}
        </ul> <!-- End ul -->
        </div> <!-- End post-group -->
        </div>

      {% else %}

        {# List of all tags used on the site #}
        <div id="header" role="banner">
          <h1 id="page-title">{{ meta.title }}</h1>
        </div>
        <div id="content">
          {% for tag in tags|sort %}
            <a class="page-tags" href="{{current_page.url}}&tag={{ tag }}">#{{ tag }}</a>
          {% endfor %}
        </div>

      {% endif %}

      {% endblock content %}

    </div>

    <div id="footer">
      <div id="nav" role="navigation" tabindex="-1">
        <a href="{{ base_url }}">{{ site_title }}</a>
        {% for page in pages(depthOffset=-1) if page.title and not page.hidden %}
          <a {% if page.id == current_page.id %} class="active"{% endif %} href="{{ page.url }}">{{ page.title }}</a>
        {% endfor %}
      </div>
    </div>

  </body>
</html>
